import numpy as np
import tkinter as tk
from tkinter import ttk, messagebox, simpledialog
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from matplotlib.patches import Wedge
import matplotlib

# ä½¿ç”¨Tkinterå…¼å®¹çš„åç«¯
matplotlib.use('TkAgg')


class InterestGroup:
    """ä»£è¡¨ä¸€ä¸ªç‰¹å®šé¢†åŸŸçš„åˆ©ç›Šé›†å›¢"""

    def __init__(self, name, ideal_allocation, influence, aggressiveness):
        """
        :param name: åˆ©ç›Šé›†å›¢åç§°
        :param ideal_allocation: ç†æƒ³åˆ†é…æ¯”ä¾‹ (0-1)
        :param influence: æ”¿æ²»å½±å“åŠ› (1-10)
        :param aggressiveness: æ¿€è¿›ç¨‹åº¦ (1-10)
        """
        self.name = name
        self.ideal_allocation = ideal_allocation
        self.influence = influence
        self.aggressiveness = aggressiveness
        self.satisfaction = 0.5  # åˆå§‹æ»¡æ„åº¦

    def calculate_satisfaction(self, actual_allocation):
        """è®¡ç®—å¯¹å®é™…åˆ†é…çš„æ»¡æ„åº¦"""
        # æ»¡æ„åº¦åŸºäºå®é™…åˆ†é…ä¸ç†æƒ³åˆ†é…çš„æ¥è¿‘ç¨‹åº¦
        allocation_diff = abs(actual_allocation - self.ideal_allocation)
        self.satisfaction = max(0, 1 - allocation_diff * 2)  # å½“åˆ†é…å·®0.5æ—¶æ»¡æ„åº¦ä¸º0

        # åŠ å…¥éšæœºå› ç´ æ¨¡æ‹Ÿä¸ç¡®å®šæ€§
        self.satisfaction *= np.random.uniform(0.9, 1.1)
        return self.satisfaction

    def apply_pressure(self, actual_allocation):
        """åŸºäºæ»¡æ„åº¦æ–½åŠ æ”¿æ²»å‹åŠ›"""
        # è®¡ç®—ä¸æ»¡æ„ç¨‹åº¦
        dissatisfaction = 1 - self.calculate_satisfaction(actual_allocation)

        # æ–½åŠ çš„å‹åŠ› = ä¸æ»¡æ„ç¨‹åº¦ Ã— å½±å“åŠ› Ã— æ¿€è¿›ç¨‹åº¦
        pressure = dissatisfaction * self.influence * self.aggressiveness / 100

        # åŠ å…¥éšæœºå› ç´ 
        pressure *= np.random.uniform(0.8, 1.2)
        return pressure

    def __str__(self):
        return f"{self.name}é›†å›¢: ç†æƒ³æ¯”ä¾‹={self.ideal_allocation:.0%}, å½±å“åŠ›={self.influence}, æ¿€è¿›æ€§={self.aggressiveness}"


class MedianVoter:
    """ä»£è¡¨ä¸­ä½é€‰æ°‘"""

    def __init__(self):
        self.ideal_allocation = {
            "æ•™è‚²": 0.22,
            "åŒ»ç–—": 0.25,
            "å›½é˜²": 0.10,
            "åŸºå»º": 0.20,
            "ç¤¾ä¼šç¦åˆ©": 0.23
        }
        self.satisfaction = 0.5

    def calculate_satisfaction(self, allocations):
        """è®¡ç®—å¯¹åˆ†é…æ–¹æ¡ˆçš„æ»¡æ„åº¦"""
        total_diff = 0
        for sector, allocation in allocations.items():
            total_diff += abs(allocation - self.ideal_allocation[sector])

        # å¹³å‡å·®å¼‚è¶Šå°ï¼Œæ»¡æ„åº¦è¶Šé«˜
        self.satisfaction = max(0, 1 - total_diff * 2)
        return self.satisfaction


class BudgetAllocationGame:
    def __init__(self, total_budget=1000):
        self.total_budget = total_budget
        self.sectors = ["æ•™è‚²", "åŒ»ç–—", "å›½é˜²", "åŸºå»º", "ç¤¾ä¼šç¦åˆ©"]

        # åˆ›å»ºåˆ©ç›Šé›†å›¢
        self.interest_groups = [
            InterestGroup("æ•™è‚²", 0.30, 8, 6),  # ç†æƒ³30%é¢„ç®—
            InterestGroup("åŒ»ç–—", 0.25, 9, 7),  # ç†æƒ³25%é¢„ç®—
            InterestGroup("å›½é˜²", 0.20, 10, 9),  # ç†æƒ³20%é¢„ç®—
            InterestGroup("åŸºå»º", 0.15, 7, 5),  # ç†æƒ³15%é¢„ç®—
            InterestGroup("ç¤¾ä¼šç¦åˆ©", 0.28, 8, 8)  # ç†æƒ³28%é¢„ç®—
        ]

        # åˆ›å»ºä¸­ä½é€‰æ°‘
        self.median_voter = MedianVoter()

        # æ¸¸æˆçŠ¶æ€
        self.term = 0
        self.support_rate = 50  # åˆå§‹æ”¯æŒç‡50%
        self.budget_history = []
        self.support_history = []
        self.allocations = {
            "æ•™è‚²": 0.20,
            "åŒ»ç–—": 0.25,
            "å›½é˜²": 0.15,
            "åŸºå»º": 0.20,
            "ç¤¾ä¼šç¦åˆ©": 0.20
        }  # åˆå§‹åˆ†é…

    def allocate_budget(self, allocations):
        """ç©å®¶åˆ†é…é¢„ç®—"""
        self.allocations = allocations

    def calculate_support_rate(self):
        """è®¡ç®—æ”¯æŒç‡å˜åŒ–"""
        allocations = self.allocations
        total_pressure = 0

        # è®¡ç®—åˆ©ç›Šé›†å›¢æ–½åŠ çš„å‹åŠ›
        group_reactions = []
        for group in self.interest_groups:
            actual_alloc = allocations[group.name]
            pressure = group.apply_pressure(actual_alloc)
            total_pressure += pressure

            # è®°å½•é›†å›¢ååº”
            reaction = "å¼ºçƒˆæŠ—è®®" if pressure > 0.15 else (
                "ä¸æ»¡" if pressure > 0.08 else (
                    "ä¸­ç«‹" if pressure > 0.03 else "æ»¡æ„"
                )
            )

            group_reactions.append({
                "name": group.name,
                "reaction": reaction,
                "satisfaction": group.satisfaction,
                "pressure": pressure
            })

        # è®¡ç®—é€‰æ°‘æ»¡æ„åº¦
        voter_satisfaction = self.median_voter.calculate_satisfaction(allocations)

        # è®¡ç®—ç¤¾ä¼šæ•ˆç›Š
        social_benefit = 0
        for sector, alloc in allocations.items():
            # ç®€å•æ¨¡å‹ï¼šåˆ†é…è¶Šæ¥è¿‘ç†æƒ³å€¼ï¼Œæ•ˆç›Šè¶Šé«˜
            if sector == "æ•™è‚²":
                ideal = 0.22
            elif sector == "åŒ»ç–—":
                ideal = 0.25
            elif sector == "å›½é˜²":
                ideal = 0.10
            elif sector == "åŸºå»º":
                ideal = 0.20
            else:  # ç¤¾ä¼šç¦åˆ©
                ideal = 0.23
            social_benefit += 1 - abs(alloc - ideal)

        social_benefit /= len(allocations)

        # è®¡ç®—æ”¯æŒç‡å˜åŒ–
        # åŸºç¡€å˜åŒ–ï¼šé€‰æ°‘æ»¡æ„åº¦ + ç¤¾ä¼šæ•ˆç›Š - åˆ©ç›Šé›†å›¢å‹åŠ›
        change = (voter_satisfaction * 30 + social_benefit * 20 - total_pressure * 25)

        # åŠ å…¥éšæœºå› ç´ 
        change *= np.random.uniform(0.8, 1.2)

        # æ›´æ–°æ”¯æŒç‡
        self.support_rate = max(10, min(90, self.support_rate + change))

        # ä¿å­˜æ”¯æŒç‡
        self.support_history.append(self.support_rate)
        self.budget_history.append(allocations.copy())

        return {
            "group_reactions": group_reactions,
            "voter_satisfaction": voter_satisfaction,
            "social_benefit": social_benefit,
            "change": change,
            "support_rate": self.support_rate
        }

    def next_term(self):
        """è¿›å…¥ä¸‹ä¸€ä»»æœŸ"""
        self.term += 1
        return self.term

    def plot_allocation(self, fig):
        """ç»˜åˆ¶é¢„ç®—åˆ†é…é¥¼å›¾"""
        allocations = self.allocations
        fig.clear()
        labels = list(allocations.keys())
        sizes = [alloc * 100 for alloc in allocations.values()]
        colors = ['#ff9999', '#66b3ff', '#99ff99', '#ffcc99', '#c2c2f0']

        ax = fig.add_subplot(111)
        ax.pie(sizes, labels=labels, colors=colors, autopct='%1.1f%%', startangle=90)
        ax.axis('equal')
        ax.set_title(f'ä»»æœŸ {self.term} é¢„ç®—åˆ†é…')
        return fig

    def plot_support_rate(self, fig):
        """ç»˜åˆ¶æ”¯æŒç‡å˜åŒ–å›¾"""
        if not self.support_history:
            return fig

        fig.clear()
        ax = fig.add_subplot(111)
        terms = range(1, len(self.support_history) + 1)
        ax.plot(terms, self.support_history, 'o-', markersize=8, linewidth=2)

        # æ·»åŠ æ ‡æ³¨
        for i, rate in enumerate(self.support_history):
            ax.annotate(f'{rate:.1f}%', (terms[i], rate),
                        textcoords="offset points",
                        xytext=(0, 10),
                        ha='center')

        ax.axhline(y=50, color='r', linestyle='--', alpha=0.5)
        ax.set_xlabel('ä»»æœŸ')
        ax.set_ylabel('æ”¯æŒç‡ (%)')
        ax.set_title('æ”¯æŒç‡å˜åŒ–è¶‹åŠ¿')
        ax.set_ylim(0, 100)
        ax.grid(True, alpha=0.3)
        return fig

    def plot_political_landscape(self, fig):
        """ç»˜åˆ¶æ”¿æ²»æ ¼å±€å›¾"""
        fig.clear()
        ax = fig.add_subplot(111, polar=True)

        # ç»˜åˆ¶æ”¯æŒç‡
        support_wedge = Wedge((0, 0), 0.6, 0, self.support_rate * 3.6,
                              color='green', alpha=0.3, label='æ”¯æŒç‡')
        ax.add_patch(support_wedge)

        # ç»˜åˆ¶åå¯¹ç‡
        oppose_wedge = Wedge((0, 0), 0.6, self.support_rate * 3.6, 360,
                             color='red', alpha=0.3, label='åå¯¹ç‡')
        ax.add_patch(oppose_wedge)

        # ç»˜åˆ¶åˆ©ç›Šé›†å›¢å½±å“
        angles = np.linspace(0, 2 * np.pi, len(self.interest_groups), endpoint=False)
        for i, group in enumerate(self.interest_groups):
            # å½±å“åŠ›è¶Šå¤§ï¼Œå°„çº¿è¶Šé•¿
            radius = 0.2 + group.influence * 0.05
            ax.plot([0, angles[i]], [0, radius], linewidth=group.aggressiveness / 2,
                    label=f"{group.name}é›†å›¢")

            # æ·»åŠ æ ‡æ³¨
            ax.text(angles[i], radius + 0.05, group.name,
                    ha='center', va='center', fontsize=9)

        # æ·»åŠ é€‰æ°‘
        ax.text(0, 0.1, "é€‰æ°‘", ha='center', va='center',
                fontsize=12, bbox=dict(facecolor='white', alpha=0.8))

        # è®¾ç½®å›¾å½¢å±æ€§
        ax.set_yticklabels([])
        ax.set_theta_zero_location('N')
        ax.set_theta_direction(-1)
        ax.set_title(f"ä»»æœŸ {self.term} æ”¿æ²»æ ¼å±€ (æ”¯æŒç‡: {self.support_rate:.1f}%)", pad=20)
        plt.legend(loc='upper right', bbox_to_anchor=(1.3, 1.1))
        return fig


class BudgetGameApp:
    def __init__(self, root):
        self.root = root
        self.root.title("é¢„ç®—åˆ†é…æŒ‘æˆ˜æ¸¸æˆ")
        self.root.geometry("1200x800")
        self.root.configure(bg="#f0f0f0")

        # åˆå§‹åŒ–æ¸¸æˆ
        self.game = BudgetAllocationGame(total_budget=1000)

        # åˆ›å»ºä¸»æ¡†æ¶
        self.main_frame = ttk.Frame(root)
        self.main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

        # åˆ›å»ºé¡¶éƒ¨ä¿¡æ¯æ 
        self.create_top_bar()

        # åˆ›å»ºåˆ†é…æ§åˆ¶é¢æ¿
        self.create_allocation_panel()

        # åˆ›å»ºå›¾è¡¨åŒºåŸŸ
        self.create_charts_area()

        # åˆ›å»ºåé¦ˆåŒºåŸŸ
        self.create_feedback_area()

        # åˆå§‹åŒ–ç•Œé¢
        self.update_display()

    def create_top_bar(self):
        """åˆ›å»ºé¡¶éƒ¨ä¿¡æ¯æ """
        top_frame = ttk.Frame(self.main_frame)
        top_frame.pack(fill=tk.X, pady=(0, 10))

        # æ¸¸æˆæ ‡é¢˜
        title_label = ttk.Label(top_frame, text="é¢„ç®—åˆ†é…æŒ‘æˆ˜æ¸¸æˆ", font=("Arial", 20, "bold"))
        title_label.pack(side=tk.LEFT)

        # ä»»æœŸä¿¡æ¯
        self.term_label = ttk.Label(top_frame, text="ä»»æœŸ: 0", font=("Arial", 14))
        self.term_label.pack(side=tk.RIGHT, padx=20)

        # æ”¯æŒç‡ä¿¡æ¯
        self.support_label = ttk.Label(top_frame, text="æ”¯æŒç‡: 50.0%", font=("Arial", 14))
        self.support_label.pack(side=tk.RIGHT, padx=20)

    def create_allocation_panel(self):
        """åˆ›å»ºé¢„ç®—åˆ†é…é¢æ¿"""
        alloc_frame = ttk.LabelFrame(self.main_frame, text="é¢„ç®—åˆ†é… (æ€»é¢„ç®—: 1000äº¿å…ƒ)")
        alloc_frame.pack(fill=tk.X, pady=10)

        # è¯´æ˜æ ‡ç­¾
        help_label = ttk.Label(alloc_frame,
                               text="è¯·ä¸ºä»¥ä¸‹é¢†åŸŸåˆ†é…é¢„ç®—æ¯”ä¾‹(æ€»å’Œå¿…é¡»ä¸º100%):",
                               font=("Arial", 10))
        help_label.grid(row=0, column=0, columnspan=3, pady=5, sticky=tk.W)

        # åˆ›å»ºæ¯”ä¾‹è¾“å…¥æ»‘å—
        self.sliders = {}
        self.slider_vars = {}
        row = 1

        for sector in self.game.sectors:
            # æ ‡ç­¾
            label = ttk.Label(alloc_frame, text=f"{sector}:", width=8)
            label.grid(row=row, column=0, padx=5, pady=5, sticky=tk.W)

            # æ»‘å—
            var = tk.DoubleVar(value=self.game.allocations[sector] * 100)
            self.slider_vars[sector] = var

            slider = ttk.Scale(alloc_frame, from_=0, to=100, orient=tk.HORIZONTAL,
                               variable=var, length=200,
                               command=lambda v, s=sector: self.update_slider_value(s))
            slider.grid(row=row, column=1, padx=5, pady=5)
            self.sliders[sector] = slider

            # æ•°å€¼æ˜¾ç¤º
            value_label = ttk.Label(alloc_frame, text=f"{var.get():.1f}%", width=6)
            value_label.grid(row=row, column=2, padx=5, pady=5)
            self.sliders[sector + "_label"] = value_label

            row += 1

        # æ€»æ¯”ä¾‹æ ‡ç­¾
        self.total_label = ttk.Label(alloc_frame, text="æ€»æ¯”ä¾‹: 0.0%", font=("Arial", 10, "bold"))
        self.total_label.grid(row=row, column=0, columnspan=2, pady=10, sticky=tk.W)

        # æŒ‰é’®åŒºåŸŸ
        button_frame = ttk.Frame(alloc_frame)
        button_frame.grid(row=row, column=2, sticky=tk.E, pady=10)

        # æäº¤æŒ‰é’®
        submit_btn = ttk.Button(button_frame, text="æäº¤é¢„ç®—åˆ†é…", command=self.submit_allocation)
        submit_btn.pack(side=tk.RIGHT, padx=5)

        # é‡ç½®æŒ‰é’®
        reset_btn = ttk.Button(button_frame, text="é‡ç½®", command=self.reset_sliders)
        reset_btn.pack(side=tk.RIGHT, padx=5)

        # è‡ªåŠ¨åˆ†é…æŒ‰é’®
        auto_btn = ttk.Button(button_frame, text="è‡ªåŠ¨åˆ†é…", command=self.auto_allocate)
        auto_btn.pack(side=tk.RIGHT, padx=5)

        # æ›´æ–°æ€»æ¯”ä¾‹
        self.update_total_percentage()

    def create_charts_area(self):
        """åˆ›å»ºå›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ"""
        chart_frame = ttk.Frame(self.main_frame)
        chart_frame.pack(fill=tk.BOTH, expand=True, pady=10)

        # é¢„ç®—åˆ†é…é¥¼å›¾
        pie_frame = ttk.LabelFrame(chart_frame, text="é¢„ç®—åˆ†é…å›¾")
        pie_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5)

        self.pie_fig = plt.Figure(figsize=(5, 4), dpi=100)
        self.pie_canvas = FigureCanvasTkAgg(self.pie_fig, master=pie_frame)
        self.pie_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        # æ”¿æ²»æ ¼å±€å›¾
        polar_frame = ttk.LabelFrame(chart_frame, text="æ”¿æ²»æ ¼å±€å›¾")
        polar_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5)

        self.polar_fig = plt.Figure(figsize=(5, 4), dpi=100)
        self.polar_canvas = FigureCanvasTkAgg(self.polar_fig, master=polar_frame)
        self.polar_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

    def create_feedback_area(self):
        """åˆ›å»ºåé¦ˆä¿¡æ¯åŒºåŸŸ"""
        feedback_frame = ttk.LabelFrame(self.main_frame, text="åˆ†é…ç»“æœåé¦ˆ")
        feedback_frame.pack(fill=tk.BOTH, pady=10)

        # åˆ›å»ºæ–‡æœ¬åŒºåŸŸ
        self.feedback_text = tk.Text(feedback_frame, height=10, wrap=tk.WORD)
        self.feedback_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        self.feedback_text.config(state=tk.DISABLED)

        # åˆ›å»ºæ”¯æŒç‡å›¾è¡¨æŒ‰é’®
        btn_frame = ttk.Frame(feedback_frame)
        btn_frame.pack(fill=tk.X, pady=5)

        history_btn = ttk.Button(btn_frame, text="æŸ¥çœ‹æ”¯æŒç‡å†å²", command=self.show_support_history)
        history_btn.pack(side=tk.RIGHT, padx=5)

        next_term_btn = ttk.Button(btn_frame, text="è¿›å…¥ä¸‹ä¸€ä»»æœŸ", command=self.next_term)
        next_term_btn.pack(side=tk.RIGHT, padx=5)

    def update_slider_value(self, sector):
        """æ›´æ–°æ»‘å—æ•°å€¼æ˜¾ç¤º"""
        value = self.slider_vars[sector].get()
        self.sliders[sector + "_label"].config(text=f"{value:.1f}%")
        self.update_total_percentage()

    def update_total_percentage(self):
        """æ›´æ–°æ€»æ¯”ä¾‹æ˜¾ç¤º"""
        total = sum(var.get() for var in self.slider_vars.values())
        self.total_label.config(text=f"æ€»æ¯”ä¾‹: {total:.1f}%")

    def reset_sliders(self):
        """é‡ç½®æ‰€æœ‰æ»‘å—"""
        for sector in self.game.sectors:
            self.slider_vars[sector].set(0)
            self.sliders[sector + "_label"].config(text="0.0%")
        self.update_total_percentage()

    def auto_allocate(self):
        """è‡ªåŠ¨åˆ†é…é¢„ç®—"""
        # éšæœºåˆ†é…ä½†ç¡®ä¿æ€»å’Œä¸º100%
        values = np.random.dirichlet(np.ones(5), size=1)[0] * 100
        for i, sector in enumerate(self.game.sectors):
            self.slider_vars[sector].set(values[i])
            self.sliders[sector + "_label"].config(text=f"{values[i]:.1f}%")
        self.update_total_percentage()

    def validate_allocation(self):
        """éªŒè¯åˆ†é…æ˜¯å¦æœ‰æ•ˆ"""
        total = sum(var.get() for var in self.slider_vars.values())
        if abs(total - 100) > 0.1:  # å…è®¸0.1%çš„è¯¯å·®
            messagebox.showerror("åˆ†é…é”™è¯¯", f"æ€»æ¯”ä¾‹å¿…é¡»ä¸º100%! å½“å‰æ€»å’Œä¸º: {total:.1f}%")
            return False
        return True

    def submit_allocation(self):
        """æäº¤é¢„ç®—åˆ†é…"""
        if not self.validate_allocation():
            return

        # è·å–åˆ†é…æ¯”ä¾‹
        allocations = {}
        for sector in self.game.sectors:
            allocations[sector] = self.slider_vars[sector].get() / 100

        # æ›´æ–°æ¸¸æˆçŠ¶æ€
        self.game.allocate_budget(allocations)

        # è®¡ç®—æ”¯æŒç‡å˜åŒ–
        result = self.game.calculate_support_rate()

        # æ›´æ–°æ˜¾ç¤º
        self.update_display(result)

        # æ˜¾ç¤ºåé¦ˆä¿¡æ¯
        self.show_feedback(result)

    def next_term(self):
        """è¿›å…¥ä¸‹ä¸€ä»»æœŸ"""
        if self.game.term == 0 and not self.game.support_history:
            messagebox.showinfo("æç¤º", "è¯·å…ˆæäº¤é¢„ç®—åˆ†é…!")
            return

        # è¿›å…¥ä¸‹ä¸€ä»»æœŸ
        term = self.game.next_term()

        # é‡ç½®åˆ†é…æ¯”ä¾‹
        self.reset_sliders()

        # æ›´æ–°æ˜¾ç¤º
        self.update_display()

        # æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
        if term >= 3:
            self.end_game()

    def update_display(self, result=None):
        """æ›´æ–°ç•Œé¢æ˜¾ç¤º"""
        # æ›´æ–°é¡¶éƒ¨ä¿¡æ¯
        self.term_label.config(text=f"ä»»æœŸ: {self.game.term}")
        if result:
            self.support_label.config(text=f"æ”¯æŒç‡: {result['support_rate']:.1f}%")
        else:
            self.support_label.config(text=f"æ”¯æŒç‡: {self.game.support_rate:.1f}%")

        # æ›´æ–°å›¾è¡¨
        self.game.plot_allocation(self.pie_fig)
        self.pie_canvas.draw()

        self.game.plot_political_landscape(self.polar_fig)
        self.polar_canvas.draw()

    def show_feedback(self, result):
        """æ˜¾ç¤ºåé¦ˆä¿¡æ¯"""
        self.feedback_text.config(state=tk.NORMAL)
        self.feedback_text.delete(1.0, tk.END)

        # æ·»åŠ åé¦ˆæ ‡é¢˜
        self.feedback_text.insert(tk.END, f"=== ä»»æœŸ {self.game.term} åˆ†é…ç»“æœ ===\n", "title")

        # æ·»åŠ é¢„ç®—åˆ†é…ä¿¡æ¯
        self.feedback_text.insert(tk.END, "\né¢„ç®—åˆ†é…ç»“æœ:\n", "subtitle")
        for sector, percent in self.game.allocations.items():
            amount = self.game.total_budget * percent
            self.feedback_text.insert(tk.END, f"  {sector}: {amount:.1f}äº¿å…ƒ ({percent:.1%})\n")

        # æ·»åŠ åˆ©ç›Šé›†å›¢ååº”
        self.feedback_text.insert(tk.END, "\nåˆ©ç›Šé›†å›¢ååº”:\n", "subtitle")
        for reaction in result['group_reactions']:
            color = "red" if "æŠ—è®®" in reaction['reaction'] or "ä¸æ»¡" in reaction['reaction'] else "green"
            self.feedback_text.insert(tk.END,
                                      f"  {reaction['name']}é›†å›¢: {reaction['reaction']} ",
                                      color)
            self.feedback_text.insert(tk.END,
                                      f"(æ»¡æ„åº¦: {reaction['satisfaction']:.1%}, å‹åŠ›: {reaction['pressure']:.3f})\n")

        # æ·»åŠ é€‰æ°‘æ»¡æ„åº¦
        self.feedback_text.insert(tk.END, "\nä¸­ä½é€‰æ°‘æ»¡æ„åº¦: ", "subtitle")
        self.feedback_text.insert(tk.END, f"{result['voter_satisfaction']:.1%}\n")

        # æ·»åŠ ç¤¾ä¼šæ•ˆç›Š
        self.feedback_text.insert(tk.END, "ç¤¾ä¼šæ•ˆç›ŠæŒ‡æ•°: ", "subtitle")
        self.feedback_text.insert(tk.END, f"{result['social_benefit']:.1%}\n")

        # æ·»åŠ æ”¯æŒç‡å˜åŒ–
        self.feedback_text.insert(tk.END, "\næ”¯æŒç‡å˜åŒ–: ", "subtitle")
        change_text = f"{'+' if result['change'] >= 0 else ''}{result['change']:.1f}%\n"
        color = "green" if result['change'] >= 0 else "red"
        self.feedback_text.insert(tk.END, change_text, color)

        self.feedback_text.insert(tk.END, f"å½“å‰æ”¯æŒç‡: {result['support_rate']:.1f}%\n", "bold")

        # æ·»åŠ çŠ¶æ€ä¿¡æ¯
        if result['support_rate'] <= 20:
            self.feedback_text.insert(tk.END, "\nâš ï¸ è­¦å‘Šï¼šä½ çš„æ”¯æŒç‡è¿‡ä½ï¼å¯èƒ½é¢ä¸´å¼¹åŠ¾é£é™©ã€‚\n", "warning")
        elif result['support_rate'] >= 80:
            self.feedback_text.insert(tk.END, "\nğŸ‰ æ­å–œï¼šä½ çš„æ”¯æŒç‡éå¸¸é«˜ï¼è¿ä»»åœ¨æœ›ã€‚\n", "success")

        # é…ç½®æ–‡æœ¬æ ·å¼
        self.feedback_text.tag_config("title", font=("Arial", 12, "bold"))
        self.feedback_text.tag_config("subtitle", font=("Arial", 10, "bold"))
        self.feedback_text.tag_config("bold", font=("Arial", 10, "bold"))
        self.feedback_text.tag_config("red", foreground="red")
        self.feedback_text.tag_config("green", foreground="green")
        self.feedback_text.tag_config("warning", foreground="orange", font=("Arial", 10, "bold"))
        self.feedback_text.tag_config("success", foreground="green", font=("Arial", 10, "bold"))

        self.feedback_text.config(state=tk.DISABLED)

    def show_support_history(self):
        """æ˜¾ç¤ºæ”¯æŒç‡å†å²å›¾è¡¨"""
        if not self.game.support_history:
            messagebox.showinfo("æç¤º", "è¿˜æ²¡æœ‰å†å²æ•°æ®!")
            return

        history_window = tk.Toplevel(self.root)
        history_window.title("æ”¯æŒç‡å†å²")
        history_window.geometry("600x500")

        fig = plt.Figure(figsize=(6, 5), dpi=100)
        self.game.plot_support_rate(fig)

        canvas = FigureCanvasTkAgg(fig, master=history_window)
        canvas.draw()
        canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

    def end_game(self):
        """ç»“æŸæ¸¸æˆå¹¶æ˜¾ç¤ºç»“æœ"""
        # åˆ›å»ºç»“æŸæ¸¸æˆçª—å£
        end_window = tk.Toplevel(self.root)
        end_window.title("æ¸¸æˆç»“æŸ")
        end_window.geometry("600x500")

        # æ·»åŠ æ ‡é¢˜
        title_label = ttk.Label(end_window, text="æ¸¸æˆç»“æŸ!", font=("Arial", 16, "bold"))
        title_label.pack(pady=10)

        # æ˜¾ç¤ºæœ€ç»ˆæ”¯æŒç‡
        final_rate = self.game.support_rate
        rate_label = ttk.Label(end_window, text=f"æœ€ç»ˆæ”¯æŒç‡: {final_rate:.1f}%", font=("Arial", 14))
        rate_label.pack(pady=5)

        # æ˜¾ç¤ºè¯„ä»·
        if final_rate >= 70:
            result_text = "å¤ªæ£’äº†ï¼ä½ æ˜¯ä¸€ä½æ°å‡ºçš„è´¢æ”¿éƒ¨é•¿ï¼ŒæˆåŠŸå¹³è¡¡äº†å„æ–¹åˆ©ç›Šï¼"
            color = "green"
        elif final_rate >= 50:
            result_text = "åšå¾—ä¸é”™ï¼ä½ æˆåŠŸå®Œæˆäº†ä»»æœŸï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´ã€‚"
            color = "blue"
        else:
            result_text = "å¾ˆé—æ†¾ï¼Œä½ æœªèƒ½å¹³è¡¡å„æ–¹åˆ©ç›Šï¼Œä¸‹æ¬¡åŠªåŠ›å§ï¼"
            color = "red"

        result_label = ttk.Label(end_window, text=result_text, font=("Arial", 12), foreground=color)
        result_label.pack(pady=10)

        # æ˜¾ç¤ºæ”¯æŒç‡å†å²å›¾è¡¨
        fig = plt.Figure(figsize=(5, 4), dpi=100)
        self.game.plot_support_rate(fig)

        canvas = FigureCanvasTkAgg(fig, master=end_window)
        canvas.draw()
        canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

        # æ·»åŠ å…³é—­æŒ‰é’®
        close_btn = ttk.Button(end_window, text="å…³é—­", command=self.root.destroy)
        close_btn.pack(pady=10)


if __name__ == "__main__":
    root = tk.Tk()
    app = BudgetGameApp(root)
    root.mainloop()
